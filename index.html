<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Interactive Handout Chat</title>
<style>
  body {
    margin: 0;
    padding: 0;
    background: #111;
    color: #eee;
    font-family: "Segoe UI", sans-serif;
  }
  .chat-container {
    max-width: 600px;
    margin: 40px auto;
    padding: 20px;
  }
  .message {
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.6s ease, transform 0.6s ease;
    margin: 16px 0;
    background: #222;
    padding: 12px 16px;
    border-radius: 8px;
    line-height: 1.6;
    white-space: pre-line;
    max-width: 85%;
  }
  .message.visible {
    opacity: 1;
    transform: translateY(0);
  }
  .message.you {
    background: #1e3a5f;
    border-radius: 8px;
    margin-left: auto;
    max-width: 70%;
    text-align: left;
  }
  .message.anonymous { background:#222;margin-right:auto; }

  .choice-option {
    outline: 2px dashed rgba(255,255,255,0.06);
    transition: background 0.3s, color 0.3s;
    cursor: pointer;
  }
  .choice-option:hover {
    background: #333;
  }
  .choice-option.clicked {
    background: #2a4a7a !important;
    color: #fff !important;
  }

  .dots { display: inline-flex; align-items: center; padding: 6px 10px; background:#333; border-radius:12px; }
  .dot { height: 6px; width: 6px; margin: 0 4px; background: #bbb; border-radius: 50%; display: inline-block; animation: blink 1.1s infinite; }
  .dot:nth-child(2) { animation-delay: 0.15s; }
  .dot:nth-child(3) { animation-delay: 0.3s; }
  @keyframes blink { 0% { opacity: 0.25; } 50% { opacity: 1; } 100% { opacity: 0.25; } }

  @media (max-width:420px) {
    .chat-container { padding: 12px; }
    .message { font-size: 14px; }
  }
</style>
</head>
<body>
<div class="chat-container" id="chat"></div>

<script>
const sequence = [
  { type: "msg", from: "anonymous", text: "やあ、遺書屋さん。久しぶり。", delay: 0, typing: 800 },
  { type: "msg", from: "anonymous", text: "このチャットに来たってことは、依頼を受けてくれたってことでいいんだよね。ありがとう", delay: 1200, typing: 800 },
  
  { type: "choice", you: "依頼内容は？", reply: [
      "同封したチケットでクルーズ船に乗って、ある人に荷物を届けて欲しい。",
      "殺人の依頼じゃなくてごめんね？でも、どうしても君たちにお願いしたいって頼まれちゃってさ。もちろん、報酬は弾むよ。"
    ]
  },
  { type: "choice", you: "荷物はどこにあるんだ", reply: [
      "出港1時間前に受け渡す。位置情報はその時送るよ、用心に越したことはないからね"
    ]
  },
  { type: "choice", you: "荷物の中身は？", reply: [
      "残念だけど、僕も中身は知らない。壊れ物らしいから丁寧に扱ってね。",
      "……念のため言っておくけど、開封したらその時点で任務失敗だからね？よろしく頼むよ"
    ]
  },
  { type: "choice", you: "誰に届ければいいんだ", reply: [
      "依頼人が当日連絡するってさ。携帯の電源は切らないでおいてくれよ"
    ]
  },
  { type: "choice", you: "船って手荷物検査があるんじゃないか？", reply: [
      "その通り。銃を直接持ち込むのは難しいだろうね。",
      "よければ知り合いのクルーに依頼してDeck 4に使えそうなものを置いておくよ",
      "……警備の目もあるし、夜になっちゃうかもしれないけど"
    ]
  },
  // 単純メッセージは type: "msg" に変更
  { type: "msg", from: "anonymous", text: "ちなみに、今回のクルーズはハロウィン仕様だそうだよ。つくづく君たちは冥界に縁があるね(笑)", delay: 1500, typing: 700 },
  { type: "msg", from: "anonymous", text: "荷物届けちゃったら暇だろうし、折角だから楽しんできてよ。1年前みたいにね。", delay: 900, typing: 700 }
];

const chat = document.getElementById("chat");

function makeMsg(text, from) {
  const div = document.createElement("div");
  div.className = from === "you" ? "message you" : "message anonymous";
  div.textContent = (from === "you" ? "you: " : "anonymous: ") + text;
  chat.appendChild(div);
  setTimeout(() => div.classList.add("visible"), 30);
  window.scrollTo(0, document.body.scrollHeight);
  return div;
}

function typingIndicator() {
  const wrap = document.createElement("div");
  wrap.className = "message anonymous";
  wrap.innerHTML = '<span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
  chat.appendChild(wrap);
  setTimeout(() => wrap.classList.add("visible"), 20);
  window.scrollTo(0, document.body.scrollHeight);
  return wrap;
}

async function playReplyList(list) {
  for (const line of list) {
    const t = typingIndicator();
    await new Promise(r => setTimeout(r, 900));
    t.remove();
    makeMsg(line, "anonymous");
    await new Promise(r => setTimeout(r, 500));
  }
}

async function playSequence() {
  for (const item of sequence) {
    if (item.type === "msg") {
      if (item.delay) await new Promise(r => setTimeout(r, item.delay));
      const t = typingIndicator();
      await new Promise(r => setTimeout(r, item.typing));
      t.remove();
      makeMsg(item.text, item.from);
    }
    if (item.type === "choice") {
      await new Promise(r => setTimeout(r, 500));
      const youMsg = makeMsg(item.you, "you");
      youMsg.classList.add("choice-option");
      await new Promise(res => {
        youMsg.addEventListener("click", async () => {
          youMsg.classList.add("clicked"); // 色を変える
          await playReplyList(item.reply);
          await new Promise(r => setTimeout(r, 300));
          res();
        }, { once: true });
      });
    }
  }
}

playSequence();
</script>
</body>
</html>
